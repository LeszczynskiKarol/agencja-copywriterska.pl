---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

type BlogCategory = CollectionEntry<'blog'>['data']['category'];

interface Props {
  categoryName: BlogCategory;
  posts: CollectionEntry<'blog'>[];
}

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  
  const categories: BlogCategory[] = [...new Set(allPosts.map(post => post.data.category))];
  
  return categories.map((category) => ({
    params: { 
      category: category.toLowerCase().replace(/\s+/g, '-').replace(/√≥/g, 'o') 
    },
    props: { 
      categoryName: category,
      posts: allPosts
        .filter(post => post.data.category === category)
        .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
    },
  }));
}

const { categoryName, posts } = Astro.props;

// Format daty
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('pl-PL', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  }).format(date);
};

// Czas czytania
const getReadingTime = (content: string) => {
  const words = content.split(/\s+/).length;
  return Math.ceil(words / 200);
};

// Slug kategorii
const getCategorySlug = (category: string) => {
  return category.toLowerCase().replace(/\s+/g, '-').replace(/√≥/g, 'o');
};

// Opisy kategorii
const categoryDescriptions: Record<BlogCategory, string> = {
  'Copywriting': 'Porady o pisaniu skutecznych tekst√≥w reklamowych, sprzeda≈ºowych i marketingowych.',
  'Content marketing': 'Strategie tworzenia tre≈õci, kt√≥re przyciƒÖgajƒÖ klient√≥w i budujƒÖ zaanga≈ºowanie.',
  'SEO i pozycjonowanie': 'Jak pisaƒá teksty zoptymalizowane pod wyszukiwarki i zwiƒôkszaƒá widoczno≈õƒá w Google.',
  'E-commerce': 'Wszystko o opisach produkt√≥w, kategorii i tre≈õciach dla sklep√≥w internetowych.',
  'Branding i naming': 'Tworzenie nazw, slogan√≥w i komunikacji marki.',
  'Social media': 'Pisanie tre≈õci na Facebook, Instagram, LinkedIn i inne platformy spo≈Çeczno≈õciowe.',
  'Poradniki': 'Praktyczne instrukcje i przewodniki krok po kroku.',
};

// Wszystkie kategorie dla nawigacji
const allPosts = await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});

const allCategories = allPosts.reduce((acc, post) => {
  const cat = post.data.category;
  acc[cat] = (acc[cat] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

// Schema.org
const categorySlug = getCategorySlug(categoryName);

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Strona g≈Ç√≥wna",
      "item": "https://agencja-copywriterska.pl"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://agencja-copywriterska.pl/blog"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": categoryName,
      "item": `https://agencja-copywriterska.pl/blog/kategoria/${categorySlug}`
    }
  ]
};
---

<BaseLayout 
  title={`${categoryName} | Blog Agencja Copywriterska`}
  description={categoryDescriptions[categoryName] || `Artyku≈Çy z kategorii ${categoryName}`}
>
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <div class="container">
      <ol class="breadcrumbs__list">
        <li><a href="/">Strona g≈Ç√≥wna</a></li>
        <li><a href="/blog">Blog</a></li>
        <li aria-current="page">{categoryName}</li>
      </ol>
    </div>
  </nav>

  <!-- Hero -->
  <section class="category-hero">
    <div class="container">
      <span class="category-hero__badge">Kategoria</span>
      <h1 class="category-hero__title">{categoryName}</h1>
      <p class="category-hero__description">
        {categoryDescriptions[categoryName] || `Wszystkie artyku≈Çy z kategorii ${categoryName}`}
      </p>
      <div class="category-hero__count">
        {posts.length} {posts.length === 1 ? 'artyku≈Ç' : posts.length < 5 ? 'artyku≈Çy' : 'artyku≈Ç√≥w'}
      </div>
    </div>
  </section>

  <!-- Categories Navigation -->
  <section class="blog-categories">
    <div class="container">
      <div class="blog-categories__list">
        <a href="/blog" class="blog-categories__item">
          Wszystkie ({allPosts.length})
        </a>
        {Object.entries(allCategories).map(([category, count]) => (
          <a 
            href={`/blog/kategoria/${getCategorySlug(category)}`}
            class={`blog-categories__item ${category === categoryName ? 'blog-categories__item--active' : ''}`}
          >
            {category} ({count})
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Posts Grid -->
  <section class="blog-posts">
    <div class="container">
      {posts.length === 0 ? (
        <div class="blog-posts__empty">
          <div class="blog-posts__empty-icon">üìù</div>
          <h3>Brak artyku≈Ç√≥w</h3>
          <p>Artyku≈Çy w tej kategorii pojawiƒÖ siƒô wkr√≥tce.</p>
          <a href="/blog" class="blog-posts__back">
            ‚Üê Wr√≥ƒá do wszystkich artyku≈Ç√≥w
          </a>
        </div>
      ) : (
        <div class="blog-posts__grid">
          {posts.map((post) => (
            <a href={`/blog/${post.slug}`} class="blog-card">
              {post.data.image ? (
                <div class="blog-card__image">
                  <img 
                    src={post.data.image} 
                    alt={post.data.imageAlt || post.data.title}
                    loading="lazy"
                  />
                </div>
              ) : (
                <div class="blog-card__image blog-card__image--placeholder">
                  <span>{post.data.title.substring(0, 2).toUpperCase()}</span>
                </div>
              )}
              <div class="blog-card__content">
                <div class="blog-card__meta">
                  <span class="blog-card__date">{formatDate(post.data.publishDate)}</span>
                </div>
                <h3 class="blog-card__title">{post.data.title}</h3>
                <p class="blog-card__excerpt">{post.data.description}</p>
                <div class="blog-card__footer">
                  <span class="blog-card__reading-time">
                    {getReadingTime(post.body || '')} min czytania
                  </span>
                  <span class="blog-card__arrow">‚Üí</span>
                </div>
              </div>
            </a>
          ))}
        </div>
      )}
      
      <!-- Back to Blog -->
      <div class="blog-posts__nav">
        <a href="/blog" class="blog-posts__back-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
          Wszystkie artyku≈Çy
        </a>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="blog-cta">
    <div class="container">
      <div class="blog-cta__card">
        <h2>Potrzebujesz profesjonalnych tekst√≥w?</h2>
        <p>Skontaktuj siƒô z nami i zam√≥w tre≈õci, kt√≥re przyciƒÖgnƒÖ klient√≥w i zwiƒôkszƒÖ sprzeda≈º.</p>
        <a href="/kontakt" class="btn btn--primary btn--lg">
          Zam√≥w bezp≈ÇatnƒÖ wycenƒô
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        </a>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Breadcrumbs */
  .breadcrumbs {
    padding: var(--space-4) 0;
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
  }
  
  .breadcrumbs__list {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: var(--text-sm);
  }
  
  .breadcrumbs__list li {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }
  
  .breadcrumbs__list li:not(:last-child)::after {
    content: "/";
    color: var(--color-text-tertiary);
  }
  
  .breadcrumbs__list a {
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: color 0.2s;
  }
  
  .breadcrumbs__list a:hover {
    color: var(--color-accent);
  }
  
  .breadcrumbs__list li[aria-current="page"] {
    color: var(--color-text-primary);
    font-weight: 500;
  }

  /* Category Hero */
  .category-hero {
    padding: var(--space-16) 0 var(--space-10);
    background: var(--color-bg-primary);
  }
  
  .category-hero .container {
    max-width: 800px;
  }
  
  .category-hero__badge {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    background: var(--color-accent-light);
    color: var(--color-accent-dark);
    font-size: var(--text-sm);
    font-weight: 600;
    border-radius: var(--radius-full);
    margin-bottom: var(--space-4);
  }
  
  .category-hero__title {
    font-family: var(--font-display);
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: var(--space-4);
  }
  
  .category-hero__description {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-4);
  }
  
  .category-hero__count {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
  }

  /* Categories */
  .blog-categories {
    padding: var(--space-8) 0;
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
    
    top: 80px;
    z-index: 50;
  }
  
  .blog-categories__list {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .blog-categories__item {
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    text-decoration: none;
    transition: all 0.2s;
  }
  
  .blog-categories__item:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }
  
  .blog-categories__item--active {
    background: var(--color-accent);
    color: var(--color-primary);
    border-color: var(--color-accent);
  }

  /* Blog Posts Grid */
  .blog-posts {
    padding: var(--space-16) 0;
    background: var(--color-bg-primary);
  }
  
  .blog-posts__grid {
    display: grid;
    gap: var(--space-6);
  }
  
  @media (min-width: 768px) {
    .blog-posts__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (min-width: 1024px) {
    .blog-posts__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  .blog-posts__empty {
    text-align: center;
    padding: var(--space-16);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
  }
  
  .blog-posts__empty-icon {
    font-size: 3rem;
    margin-bottom: var(--space-4);
  }
  
  .blog-posts__empty h3 {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
  }
  
  .blog-posts__empty p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
  }
  
  .blog-posts__back {
    color: var(--color-accent);
    text-decoration: none;
  }
  
  .blog-posts__back:hover {
    text-decoration: underline;
  }
  
  .blog-posts__nav {
    margin-top: var(--space-12);
    text-align: center;
  }
  
  .blog-posts__back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-accent);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
  }
  
  .blog-posts__back-link:hover {
    transform: translateX(-4px);
  }

  /* Blog Card */
  .blog-card {
    display: flex;
    flex-direction: column;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
    text-decoration: none;
    transition: all 0.3s ease;
  }
  
  .blog-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }
  
  .blog-card__image {
    aspect-ratio: 16/9;
    overflow: hidden;
    background: var(--color-bg-tertiary);
  }
  
  .blog-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }
  
  .blog-card:hover .blog-card__image img {
    transform: scale(1.05);
  }
  
  .blog-card__image--placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-accent-light) 0%, var(--color-bg-tertiary) 100%);
  }
  
  .blog-card__image--placeholder span {
    font-family: var(--font-display);
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-accent);
    opacity: 0.5;
  }
  
  .blog-card__content {
    padding: var(--space-6);
    display: flex;
    flex-direction: column;
    flex: 1;
  }
  
  .blog-card__meta {
    margin-bottom: var(--space-3);
  }
  
  .blog-card__date {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
  }
  
  .blog-card__title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--color-text-primary);
    line-height: 1.3;
    margin-bottom: var(--space-3);
    transition: color 0.2s;
  }
  
  .blog-card:hover .blog-card__title {
    color: var(--color-accent);
  }
  
  .blog-card__excerpt {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-4);
    flex: 1;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .blog-card__footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
  }
  
  .blog-card__reading-time {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
  }
  
  .blog-card__arrow {
    font-size: var(--text-lg);
    color: var(--color-accent);
    transition: transform 0.2s;
  }
  
  .blog-card:hover .blog-card__arrow {
    transform: translateX(4px);
  }

  /* CTA */
  .blog-cta {
    padding: var(--space-20) 0;
    background: var(--color-bg-secondary);
  }
  
  .blog-cta__card {
    max-width: 700px;
    margin: 0 auto;
    padding: var(--space-12);
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    border-radius: var(--radius-xl);
    text-align: center;
    color: white;
  }
  
  .blog-cta__card h2 {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: 700;
    margin-bottom: var(--space-4);
  }
  
  .blog-cta__card p {
    opacity: 0.9;
    margin-bottom: var(--space-8);
    font-size: var(--text-lg);
  }
  
  .blog-cta__card .btn {
    background: var(--color-accent);
    color: var(--color-primary);
  }
  
  .blog-cta__card .btn:hover {
    background: white;
  }
</style>